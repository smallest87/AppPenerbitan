{% extends 'base.html' %}

{% block title %}Area Produksi{% endblock %}

{% block content %}
<div class="bg-red-900 text-white -m-6 mb-6 p-6 shadow-md border-b-4 border-red-700">
    <div class="flex justify-between items-center">
        <div>
            <h2 class="text-2xl font-bold uppercase tracking-wide">üè≠ SPK - Divisi Produksi</h2>
            <p class="opacity-80 text-sm mt-1">Operator: {{ user.username }}</p>
        </div>
        <div class="bg-white/10 px-4 py-2 rounded text-center">
            <span class="block text-xs uppercase opacity-75">Total Antrian</span>
            <span class="text-2xl font-bold">{{ orders.count }}</span>
        </div>
    </div>
</div>

<div class="grid gap-6">
    {% for order in orders %}
    <div class="bg-white rounded-lg shadow-md border-l-4 {% if order.workflow.status_finishing == 'SELESAI' %}border-green-500 opacity-60{% else %}border-red-500{% endif %} overflow-hidden relative">
        
        {% if order.workflow.status_finishing == 'SELESAI' %}
        <div class="absolute top-0 right-0 bg-green-500 text-white px-3 py-1 text-xs font-bold rounded-bl">SELESAI</div>
        {% endif %}

        <div class="bg-gray-50 p-4 border-b border-gray-100 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <span class="text-xs font-bold text-gray-400 uppercase tracking-wider">Order #{{ order.nomor_order }}</span>
                <h3 class="text-xl font-bold text-slate-800">{{ order.judul_buku }}</h3>
            </div>
            
            <div class="flex gap-2 justify-end items-start">
                {% if order.workflow.file_layout_final %}
                <a href="{{ order.workflow.file_layout_final.url }}" target="_blank" class="flex items-center gap-1 bg-indigo-50 text-indigo-700 px-3 py-1 rounded text-xs font-bold hover:bg-indigo-100">
                    üìÇ Unduh Layout
                </a>
                {% endif %}
                
                {% if order.workflow.file_cover_final %}
                <a href="{{ order.workflow.file_cover_final.url }}" target="_blank" class="flex items-center gap-1 bg-purple-50 text-purple-700 px-3 py-1 rounded text-xs font-bold hover:bg-purple-100">
                    üñºÔ∏è Unduh Cover
                </a>
                {% endif %}
            </div>
        </div>

        <div class="p-4 grid md:grid-cols-3 gap-6 text-sm">
            <div>
                <p class="text-gray-500">Ukuran</p>
                <p class="font-bold text-slate-800">{{ order.spesifikasi.ukuran_buku }}</p>
            </div>
            <div>
                <p class="text-gray-500">Finishing Sampul</p>
                <p class="font-bold text-slate-800">
                    {{ order.spesifikasi.get_jenis_sampul_display }} / {{ order.spesifikasi.get_laminasi_display }}
                </p>
            </div>
            <div class="bg-yellow-50 p-2 rounded border border-yellow-200 text-yellow-800 text-xs">
                <strong>Catatan:</strong> {{ order.spesifikasi.catatan_teknis|default:"-" }}
            </div>
        </div>

        <div class="bg-gray-100 p-4 grid grid-cols-1 md:grid-cols-3 gap-4 border-t border-gray-200">
            
            <div class="bg-white p-3 rounded shadow-sm">
                <div class="flex justify-between items-center mb-2">
                    <span class="font-bold text-gray-600 text-xs uppercase">1. Cetak Isi</span>
                    <span class="text-xs font-mono {% if order.workflow.status_cetak == 'SELESAI' %}text-green-600{% endif %}">
                        {{ order.workflow.get_status_cetak_display }}
                    </span>
                </div>
                {% if order.workflow.status_cetak != 'SELESAI' %}
                <form action="{% url 'update_produksi' order.workflow.id %}" method="POST" class="flex gap-1">
                    {% csrf_token %}
                    <input type="hidden" name="process_type" value="cetak">
                    <button type="submit" name="new_status" value="PROSES" class="flex-1 bg-yellow-400 hover:bg-yellow-500 text-white text-xs py-1 rounded">Proses</button>
                    <button type="submit" name="new_status" value="SELESAI" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white text-xs py-1 rounded">Selesai</button>
                </form>
                {% else %}
                <div class="text-center text-green-600 text-xs font-bold bg-green-50 py-1 rounded">‚úÖ Tuntas</div>
                {% endif %}
            </div>

            <div class="bg-white p-3 rounded shadow-sm">
                <div class="flex justify-between items-center mb-2">
                    <span class="font-bold text-gray-600 text-xs uppercase">2. Jilid/Binding</span>
                    <span class="text-xs font-mono {% if order.workflow.status_binding == 'SELESAI' %}text-green-600{% endif %}">
                        {{ order.workflow.get_status_binding_display }}
                    </span>
                </div>
                {% if order.workflow.status_cetak == 'SELESAI' and order.workflow.status_binding != 'SELESAI' %}
                <form action="{% url 'update_produksi' order.workflow.id %}" method="POST" class="flex gap-1">
                    {% csrf_token %}
                    <input type="hidden" name="process_type" value="binding">
                    <button type="submit" name="new_status" value="PROSES" class="flex-1 bg-yellow-400 hover:bg-yellow-500 text-white text-xs py-1 rounded">Proses</button>
                    <button type="submit" name="new_status" value="SELESAI" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white text-xs py-1 rounded">Selesai</button>
                </form>
                {% elif order.workflow.status_binding == 'SELESAI' %}
                <div class="text-center text-green-600 text-xs font-bold bg-green-50 py-1 rounded">‚úÖ Tuntas</div>
                {% else %}
                <div class="text-center text-gray-400 text-xs italic bg-gray-50 py-1 rounded">Tunggu Cetak</div>
                {% endif %}
            </div>

            <div class="bg-white p-3 rounded shadow-sm">
                <div class="flex justify-between items-center mb-2">
                    <span class="font-bold text-gray-600 text-xs uppercase">3. Finishing</span>
                    <span class="text-xs font-mono {% if order.workflow.status_finishing == 'SELESAI' %}text-green-600{% endif %}">
                        {{ order.workflow.get_status_finishing_display }}
                    </span>
                </div>
                {% if order.workflow.status_binding == 'SELESAI' and order.workflow.status_finishing != 'SELESAI' %}
                <form action="{% url 'update_produksi' order.workflow.id %}" method="POST" class="flex gap-1">
                    {% csrf_token %}
                    <input type="hidden" name="process_type" value="finishing">
                    <button type="submit" name="new_status" value="PROSES" class="flex-1 bg-yellow-400 hover:bg-yellow-500 text-white text-xs py-1 rounded">Proses</button>
                    <button type="submit" name="new_status" value="SELESAI" class="flex-1 bg-green-600 hover:bg-green-700 text-white text-xs py-1 rounded font-bold">FINISH ORDER</button>
                </form>
                {% elif order.workflow.status_finishing == 'SELESAI' %}
                <div class="text-center text-green-600 text-xs font-bold bg-green-50 py-1 rounded">‚úÖ SIAP DIAMBIL</div>
                {% else %}
                <div class="text-center text-gray-400 text-xs italic bg-gray-50 py-1 rounded">Tunggu Jilid</div>
                {% endif %}
            </div>

        </div>
    </div>
    {% empty %}
    <div class="text-center py-10 text-gray-400">Tidak ada SPK aktif.</div>
    {% endfor %}
</div>
{% endblock %}